// üîê SERVICIO DE AUTENTICACI√ìN
// Este servicio maneja todo lo relacionado con login, registro y autenticaci√≥n

using SistemaPonchado.Data;
using SistemaPonchado.Models;
using Microsoft.EntityFrameworkCore;

namespace SistemaPonchado.Services
{
    // üí° CONCEPTO: Un "Service" contiene la l√≥gica de negocio
    // Separamos la l√≥gica de los formularios para mantener el c√≥digo organizado
    public class AuthService
    {
        // üóÑÔ∏è CONTEXTO DE BASE DE DATOS
        // Esta es nuestra conexi√≥n a la base de datos SQLite
        private readonly SistemaPonchadoContext _context;

        // üèóÔ∏è CONSTRUCTOR: Se ejecuta cuando creamos una nueva instancia
        public AuthService()
        {
            _context = new SistemaPonchadoContext();
        }

        /// <summary>
        /// üîç AUTENTICAR USUARIO
        /// Verifica si el usuario y contrase√±a son correctos
        /// </summary>
        /// <param name="nombreUsuario">Nombre de usuario ingresado</param>
        /// <param name="password">Contrase√±a en texto plano</param>
        /// <returns>Usuario si es v√°lido, null si no lo es</returns>
        public async Task<Usuario?> AutenticarUsuario(string nombreUsuario, string password)
        {
            // üîé BUSCAR USUARIO EN BASE DE DATOS
            // Include() carga tambi√©n los datos del empleado relacionado
            var usuario = await _context.Usuarios
                .Include(u => u.Empleado) // üí° Esto carga los datos del empleado autom√°ticamente
                .FirstOrDefaultAsync(u => u.NombreUsuario == nombreUsuario && u.Activo);

            // üîí VERIFICAR CONTRASE√ëA
            // BCrypt compara la contrase√±a en texto plano con la encriptada
            if (usuario != null && BCrypt.Net.BCrypt.Verify(password, usuario.Password))
            {
                return usuario; // ‚úÖ Login exitoso
            }

            return null; // ‚ùå Credenciales incorrectas
        }

        /// <summary>
        /// üîÑ CAMBIAR CONTRASE√ëA
        /// Permite al usuario cambiar su contrase√±a actual
        /// </summary>
        public async Task<bool> CambiarPassword(int usuarioId, string passwordAnterior, string passwordNuevo)
        {
            var usuario = await _context.Usuarios.FindAsync(usuarioId);
            if (usuario == null)
                return false;

            // Verificar password anterior
            if (!BCrypt.Net.BCrypt.Verify(passwordAnterior, usuario.Password))
                return false;

            // Actualizar password
            usuario.Password = BCrypt.Net.BCrypt.HashPassword(passwordNuevo);
            usuario.RequiereCambioPassword = false;

            await _context.SaveChangesAsync();
            return true;
        }

        public async Task<Usuario?> CrearUsuarioEmpleado(Empleado empleado)
        {
            // Generar nombre de usuario √∫nico
            var baseUsername = GenerarNombreUsuario(empleado.NombreCompleto);
            var uniqueUsername = await AsegurarNombreUsuarioUnico(baseUsername);

            // Asegurar password a partir de √∫ltimos 4 d√≠gitos de c√©dula
            string last4 = "1234";
            if (!string.IsNullOrWhiteSpace(empleado.Cedula))
            {
                last4 = empleado.Cedula.Length >= 4 ? empleado.Cedula[^4..] : empleado.Cedula;
            }

            var usuario = new Usuario
            {
                NombreUsuario = uniqueUsername,
                Password = BCrypt.Net.BCrypt.HashPassword(last4),
                Rol = "Empleado",
                RequiereCambioPassword = true,
                EmpleadoId = empleado.Id,
                Activo = true
            };

            _context.Usuarios.Add(usuario);
            await _context.SaveChangesAsync();

            return usuario;
        }

        public async Task<Usuario?> ObtenerUsuarioPorEmpleadoId(int empleadoId)
        {
            return await _context.Usuarios.FirstOrDefaultAsync(u => u.EmpleadoId == empleadoId);
        }

        private static string GenerarNombreUsuario(string nombreCompleto)
        {
            var partes = nombreCompleto.Trim().Split(' ', StringSplitOptions.RemoveEmptyEntries);
            if (partes.Length >= 2)
            {
                return (partes[0].Substring(0, 1) + partes[1]).ToLower();
            }
            return nombreCompleto.Replace(" ", "").ToLower();
        }

        private async Task<string> AsegurarNombreUsuarioUnico(string baseUsername)
        {
            string candidate = baseUsername;
            int suffix = 0;
            while (true)
            {
                var exists = await _context.Usuarios.AnyAsync(u => u.NombreUsuario == candidate);
                if (!exists) return candidate;
                suffix++;
                candidate = baseUsername + suffix.ToString();
            }
        }

        public async Task InicializarBaseDatos()
        {
            try
            {
                await _context.Database.EnsureCreatedAsync();
                
                // Verificar si ya existe el usuario admin
                var adminExiste = await _context.Usuarios.AnyAsync(u => u.Rol == "Admin");
                
                if (!adminExiste)
                {
                    var admin = new Usuario
                    {
                        NombreUsuario = "admin",
                        Password = BCrypt.Net.BCrypt.HashPassword("admin123"),
                        Rol = "Admin",
                        RequiereCambioPassword = false,
                        Activo = true
                    };
                    
                    _context.Usuarios.Add(admin);
                    await _context.SaveChangesAsync();
                }
            }
            catch (Exception ex)
            {
                // Log error
                Console.WriteLine($"Error inicializando base de datos: {ex.Message}");
                throw;
            }
        }

        public void Dispose()
        {
            _context?.Dispose();
        }
    }
}
